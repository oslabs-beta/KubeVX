{"version":3,"names":["_helperPluginUtils","require","_helperModuleImports","_core","_helpers","_index","_coreJs","_index2","supportsStaticESM","caller","_default","exports","default","declare","api","options","dirname","_options$corejs","assertVersion","helpers","useRuntimeHelpers","useESModules","version","runtimeVersion","absoluteRuntime","Error","DUAL_MODE_RUNTIME","supportsCJSDefault","hasMinVersion","has","obj","key","Object","prototype","hasOwnProperty","call","esModules","HEADER_HELPERS","name","inherits","babel7","createPolyfillPlugins","corejs","createCorejs3Plugin","pre","file","modulePath","set","_modulePath","_file$get","getRuntimePath","get","availableHelper","t","arrowFunctionExpression","identifier","isInteropHelper","indexOf","blockHoist","isModule","path","undefined","helpersDir","node","sourceType","helperPath","resolveFSPath","addDefaultImport","cache","Map","source","nameHint","isHelper","cacheKey","cached","cloneNode","addDefault","importedInterop"],"sources":["../src/index.ts"],"sourcesContent":["import { declare } from \"@babel/helper-plugin-utils\";\nimport { addDefault, isModule } from \"@babel/helper-module-imports\";\nimport { types as t, type CallerMetadata } from \"@babel/core\";\n\nimport { hasMinVersion } from \"./helpers.ts\";\nimport getRuntimePath, { resolveFSPath } from \"./get-runtime-path/index.ts\";\nimport { createCorejs3Plugin } from \"./core-js.ts\";\n\n// TODO(Babel 8): Remove this\nimport babel7 from \"./babel-7/index.cjs\";\n\nfunction supportsStaticESM(caller: CallerMetadata | undefined) {\n  // @ts-expect-error TS does not narrow down optional chaining\n  return !!caller?.supportsStaticESM;\n}\n\nexport interface Options {\n  absoluteRuntime?: boolean;\n  corejs?: string | number | { version: string | number; proposals?: boolean };\n  helpers?: boolean;\n  useESModules?: boolean | \"auto\";\n  version?: string;\n}\n\nexport default declare((api, options: Options, dirname) => {\n  api.assertVersion(\n    process.env.BABEL_8_BREAKING && process.env.IS_PUBLISH\n      ? PACKAGE_JSON.version\n      : 7,\n  );\n\n  const {\n    helpers: useRuntimeHelpers = true,\n    useESModules = false,\n    version: runtimeVersion = \"7.0.0-beta.0\",\n    absoluteRuntime = false,\n  } = options;\n\n  if (typeof useRuntimeHelpers !== \"boolean\") {\n    throw new Error(\"The 'helpers' option must be undefined, or a boolean.\");\n  }\n\n  if (typeof useESModules !== \"boolean\" && useESModules !== \"auto\") {\n    throw new Error(\n      \"The 'useESModules' option must be undefined, or a boolean, or 'auto'.\",\n    );\n  }\n\n  if (\n    typeof absoluteRuntime !== \"boolean\" &&\n    typeof absoluteRuntime !== \"string\"\n  ) {\n    throw new Error(\n      \"The 'absoluteRuntime' option must be undefined, a boolean, or a string.\",\n    );\n  }\n\n  if (typeof runtimeVersion !== \"string\") {\n    throw new Error(`The 'version' option must be a version string.`);\n  }\n\n  if (!process.env.BABEL_8_BREAKING) {\n    // In recent @babel/runtime versions, we can use require(\"helper\").default\n    // instead of require(\"helper\") so that it has the same interface as the\n    // ESM helper, and bundlers can better exchange one format for the other.\n    const DUAL_MODE_RUNTIME = \"7.13.0\";\n    // eslint-disable-next-line no-var\n    var supportsCJSDefault = hasMinVersion(DUAL_MODE_RUNTIME, runtimeVersion);\n  }\n\n  function has(obj: {}, key: string) {\n    return Object.prototype.hasOwnProperty.call(obj, key);\n  }\n\n  if (has(options, \"useBuiltIns\")) {\n    // @ts-expect-error deprecated options\n    if (options[\"useBuiltIns\"]) {\n      throw new Error(\n        \"The 'useBuiltIns' option has been removed. The @babel/runtime \" +\n          \"module now uses builtins by default.\",\n      );\n    } else {\n      throw new Error(\n        \"The 'useBuiltIns' option has been removed. Use the 'corejs'\" +\n          \"option to polyfill with `core-js` via @babel/runtime.\",\n      );\n    }\n  }\n\n  if (has(options, \"polyfill\")) {\n    // @ts-expect-error deprecated options\n    if (options[\"polyfill\"] === false) {\n      throw new Error(\n        \"The 'polyfill' option has been removed. The @babel/runtime \" +\n          \"module now skips polyfilling by default.\",\n      );\n    } else {\n      throw new Error(\n        \"The 'polyfill' option has been removed. Use the 'corejs'\" +\n          \"option to polyfill with `core-js` via @babel/runtime.\",\n      );\n    }\n  }\n\n  if (has(options, \"moduleName\")) {\n    throw new Error(\n      \"The 'moduleName' option has been removed. @babel/transform-runtime \" +\n        \"no longer supports arbitrary runtimes. If you were using this to \" +\n        \"set an absolute path for Babel's standard runtimes, please use the \" +\n        \"'absoluteRuntime' option.\",\n    );\n  }\n\n  if (process.env.BABEL_8_BREAKING) {\n    if (has(options, \"regenerator\")) {\n      throw new Error(\n        \"The 'regenerator' option has been removed. The generators transform \" +\n          \"no longers relies on a 'regeneratorRuntime' global. \" +\n          \"If you still need to replace imports to the 'regeneratorRuntime' \" +\n          \"global, you can use babel-plugin-polyfill-regenerator.\",\n      );\n    }\n  }\n\n  const esModules =\n    useESModules === \"auto\" ? api.caller(supportsStaticESM) : useESModules;\n\n  const HEADER_HELPERS = [\"interopRequireWildcard\", \"interopRequireDefault\"];\n\n  return {\n    name: \"transform-runtime\",\n\n    inherits: process.env.BABEL_8_BREAKING\n      ? options.corejs\n        ? createCorejs3Plugin(options.corejs, absoluteRuntime)\n        : undefined\n      : babel7.createPolyfillPlugins(\n          options,\n          runtimeVersion,\n          absoluteRuntime,\n          options.corejs === 3 ||\n            (options.corejs as Options[\"corejs\"] & object)?.version === 3\n            ? createCorejs3Plugin(options.corejs, absoluteRuntime)\n            : null,\n        ),\n\n    pre(file) {\n      if (!useRuntimeHelpers) return;\n\n      let modulePath: string;\n\n      file.set(\"helperGenerator\", (name: string) => {\n        modulePath ??= getRuntimePath(\n          file.get(\"runtimeHelpersModuleName\") ?? \"@babel/runtime\",\n          dirname,\n          absoluteRuntime,\n        );\n\n        // If the helper didn't exist yet at the version given, we bail\n        // out and let Babel either insert it directly, or throw an error\n        // so that plugins can handle that case properly.\n        if (!process.env.BABEL_8_BREAKING) {\n          if (!file.availableHelper?.(name, runtimeVersion)) {\n            if (name === \"regeneratorRuntime\") {\n              // For regeneratorRuntime, we can fallback to the old behavior of\n              // relying on the regeneratorRuntime global. If the 'regenerator'\n              // option is not disabled, babel-plugin-polyfill-regenerator will\n              // then replace it with a @babel/helpers/regenerator import.\n              //\n              // We must wrap it in a function, because built-in Babel helpers\n              // are functions.\n              return t.arrowFunctionExpression(\n                [],\n                t.identifier(\"regeneratorRuntime\"),\n              );\n            }\n            return;\n          }\n        } else {\n          if (!file.availableHelper(name, runtimeVersion)) return;\n        }\n\n        const isInteropHelper = HEADER_HELPERS.indexOf(name) !== -1;\n\n        // Explicitly set the CommonJS interop helpers to their reserve\n        // blockHoist of 4 so they are guaranteed to exist\n        // when other things used them to import.\n        const blockHoist =\n          isInteropHelper && !isModule(file.path) ? 4 : undefined;\n\n        const helpersDir =\n          esModules && file.path.node.sourceType === \"module\"\n            ? \"helpers/esm\"\n            : \"helpers\";\n\n        let helperPath = `${modulePath}/${helpersDir}/${name}`;\n        if (absoluteRuntime) helperPath = resolveFSPath(helperPath);\n\n        return addDefaultImport(helperPath, name, blockHoist, true);\n      });\n\n      const cache = new Map();\n\n      function addDefaultImport(\n        source: string,\n        nameHint: string,\n        blockHoist: number,\n        isHelper = false,\n      ) {\n        // If something on the page adds a helper when the file is an ES6\n        // file, we can't reused the cached helper name after things have been\n        // transformed because it has almost certainly been renamed.\n        const cacheKey = isModule(file.path);\n        const key = `${source}:${nameHint}:${cacheKey || \"\"}`;\n\n        let cached = cache.get(key);\n        if (cached) {\n          cached = t.cloneNode(cached);\n        } else {\n          cached = addDefault(file.path, source, {\n            importedInterop: (\n              process.env.BABEL_8_BREAKING\n                ? isHelper\n                : isHelper && supportsCJSDefault\n            )\n              ? \"compiled\"\n              : \"uncompiled\",\n            nameHint,\n            blockHoist,\n          });\n\n          cache.set(key, cached);\n        }\n        return cached;\n      }\n    },\n  };\n});\n"],"mappings":"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"}